$Id: drac_auth.patch,v 1.17.2.2 2005/12/13 18:46:16 murch Exp $

Patch to add support for Dynamic Relay Authorization Control

For more information about DRAC, see:
	http://mail.cc.umanitoba.ca/drac/index.html


Installation
------------

1.  Apply this patch in the toplevel directory using the following command:

	# patch -p0 < contrib/drac_auth.patch

2.  Cleanup any previous builds:

	# make distclean

3a. If you DO NOT have 'smake' and 'autoconf' installed on your system, goto
    step 3b.

    Perform the following to reconfigure your build:

	# rm configure
	# sh SMakefile
	# ./configure ... --with-drac=<location of libdrac>

    NOTE: you can find your original configure command in config.status

    Proceed to step 4.

3b. Edit imap/Makefile and modify the following three variables:

	DEFS = ... -DDRAC_AUTH
	LIBS = ... -ldrac
	LDFLAGS = ... -L<location of libdrac>

4.  Build and install the software:

	# make
	# make install

5.  If dracd is not running on the same system as Cyrus (localhost),
    use the 'drachost' option in imapd.conf(5) to specify the hostname of
    the dracd server.

6.  Installation is complete!


Operation
---------

The behavior of DRAC is controlled by the value of the 'dracinterval' option
in imapd.conf(5).  If 'dracinterval' is 0 (zero), DRAC support is disabled.
Otherwise, DRAC support is enabled and has the following behavior:

pop3d: Whenever a client opens a user's INBOX, drac_auth() is called.

imapd: Once a client is logged in (via LOGIN or AUTHENTICATE),
       drac_send() will be called once every 'dracinterval' minutes.





Index: configure.in
===================================================================
RCS file: /afs/andrew/system/cvs/src/cyrus/configure.in,v
retrieving revision 1.268.2.23
diff -u -r1.268.2.23 configure.in
--- configure.in	12 Apr 2005 20:05:20 -0000	1.268.2.23
+++ configure.in	13 Dec 2005 18:38:54 -0000
@@ -1003,6 +1003,19 @@
 SNMP_SUBDIRS=""
 AC_SUBST(SNMP_SUBDIRS)
 
+dnl
+dnl Test for DRAC
+dnl
+DRACLIBS=
+AC_ARG_WITH(drac, [  --with-drac=DIR         use DRAC library in <DIR> [no] ],
+	if test -d "$withval"; then
+		LDFLAGS="$LDFLAGS -L${withval}"
+		AC_CHECK_LIB(drac, dracauth,
+			AC_DEFINE(DRAC_AUTH,[],[Build DRAC support?])
+			DRACLIBS="-ldrac")
+	fi)
+AC_SUBST(DRACLIBS)
+
 CMU_LIBWRAP
 CMU_UCDSNMP
 
Index: contrib/drac_auth.patch
===================================================================
RCS file: /afs/andrew/system/cvs/src/cyrus/contrib/drac_auth.patch,v
retrieving revision 1.17.2.1
diff -u -r1.17.2.1 drac_auth.patch
--- contrib/drac_auth.patch	15 Jan 2004 20:24:23 -0000	1.17.2.1
+++ contrib/drac_auth.patch	13 Dec 2005 18:38:54 -0000
@@ -65,13 +65,10 @@
 
 
 Index: configure.in
-===================================================================
-RCS file: /afs/andrew/system/cvs/src/cyrus/configure.in,v
-retrieving revision 1.273
-diff -u -r1.273 configure.in
---- configure.in	15 Dec 2003 20:00:35 -0000	1.273
-+++ configure.in	19 Dec 2003 19:56:16 -0000
-@@ -945,6 +945,19 @@
+diff -u configure.in.orig configure.in
+--- configure.in.orig	Wed Apr 13 05:05:20 2005
++++ configure.in	Sat Dec 10 16:16:15 2005
+@@ -1003,6 +1003,19 @@
  SNMP_SUBDIRS=""
  AC_SUBST(SNMP_SUBDIRS)
  
@@ -92,13 +89,10 @@
  CMU_UCDSNMP
  
 Index: imap/Makefile.in
-===================================================================
-RCS file: /afs/andrew/system/cvs/src/cyrus/imap/Makefile.in,v
-retrieving revision 1.179
-diff -u -r1.179 Makefile.in
---- imap/Makefile.in	12 Nov 2003 04:02:01 -0000	1.179
-+++ imap/Makefile.in	19 Dec 2003 19:56:19 -0000
-@@ -67,6 +67,7 @@
+diff -u imap/Makefile.in.orig imap/Makefile.in
+--- imap/Makefile.in.orig	Fri Nov 18 00:46:14 2005
++++ imap/Makefile.in	Sat Dec 10 16:17:44 2005
+@@ -66,6 +66,7 @@
  SIEVE_LIBS = @SIEVE_LIBS@
  IMAP_COM_ERR_LIBS = @IMAP_COM_ERR_LIBS@
  LIB_WRAP = @LIB_WRAP@
@@ -106,7 +100,7 @@
  LIBS = $(IMAP_LIBS) $(IMAP_COM_ERR_LIBS)
  DEPLIBS = ../lib/libcyrus.a ../lib/libcyrus_min.a @DEPLIBS@
  
-@@ -215,17 +216,17 @@
+@@ -202,17 +203,17 @@
  imapd: xversion $(IMAPDOBJS) mutex_fake.o libimap.a $(DEPLIBS) $(SERVICE)
  	$(CC) $(LDFLAGS) -o imapd \
  	 $(SERVICE) $(IMAPDOBJS) mutex_fake.o \
@@ -125,25 +119,22 @@
 -	$(DEPLIBS) $(LIBS) $(LIB_WRAP)
 +	$(DEPLIBS) $(LIBS) $(LIB_WRAP) $(DRAC_LIBS) $(DRAC_LIBS)
  
- proxyd: $(PROXYDOBJS) mutex_fake.o libimap.a $(DEPLIBS) $(SERVICE)
- 	$(CC) $(LDFLAGS) -o proxyd \
-@@ -252,7 +253,7 @@
- 
- pop3d: pop3d.o backend.o tls.o mutex_fake.o libimap.a $(DEPLIBS) $(SERVICE)
- 	$(CC) $(LDFLAGS) -o pop3d pop3d.o backend.o tls.o $(SERVICE) \
+ mupdate: mupdate.o mupdate-slave.o mupdate-client.o mutex_pthread.o tls.o \
+ 	libimap.a $(DEPLIBS)
+@@ -230,7 +231,7 @@
+ pop3d: pop3d.o proxy.o backend.o tls.o mutex_fake.o libimap.a \
+ 	$(DEPLIBS) $(SERVICE)
+ 	$(CC) $(LDFLAGS) -o pop3d pop3d.o proxy.o backend.o tls.o $(SERVICE) \
 -	 mutex_fake.o libimap.a $(DEPLIBS) $(LIBS) $(LIB_WRAP)
 +	 mutex_fake.o libimap.a $(DEPLIBS) $(LIBS) $(LIB_WRAP) $(DRAC_LIBS)
  
- nntpd: nntpd.o backend.o index.o smtpclient.o spool.o tls.o \
+ nntpd: nntpd.o proxy.o backend.o index.o smtpclient.o spool.o tls.o \
  	 mutex_fake.o nntp_err.o libimap.a $(DEPLIBS) $(SERVICE)
 Index: imap/imapd.c
-===================================================================
-RCS file: /afs/andrew/system/cvs/src/cyrus/imap/imapd.c,v
-retrieving revision 1.448
-diff -u -r1.448 imapd.c
---- imap/imapd.c	5 Dec 2003 21:33:07 -0000	1.448
-+++ imap/imapd.c	19 Dec 2003 19:56:19 -0000
-@@ -126,6 +126,18 @@
+diff -u -p imap/imapd.c.orig imap/imapd.c
+--- imap/imapd.c.orig	Tue Nov 22 04:48:36 2005
++++ imap/imapd.c	Sat Dec 10 16:16:16 2005
+@@ -172,6 +172,18 @@ static struct proxy_context imapd_proxyc
      1, 1, &imapd_authstate, &imapd_userisadmin, &imapd_userisproxyadmin
  };
  
@@ -162,9 +153,9 @@
  /* current sub-user state */
  static struct mailbox mboxstruct;
  static struct mailbox *imapd_mailbox;
-@@ -446,6 +458,23 @@
-     /* setup for sending IMAP IDLE notifications */
-     idle_enabled();
+@@ -637,6 +649,23 @@ int service_init(int argc, char **argv, 
+ 	idle_init();
+     }
  
 +#ifdef DRAC_AUTH
 +    /* setup for sending DRAC "pings" */
@@ -186,7 +177,7 @@
      /* create connection to the SNMP listener, if available. */
      snmp_connect(); /* ignore return code */
      snmp_set_str(SERVER_NAME_VERSION,CYRUS_VERSION);
-@@ -531,6 +560,15 @@
+@@ -741,6 +770,15 @@ int service_main(int argc __attribute__(
  		imapd_haveaddr = 1;
  	    }
  	}
@@ -202,7 +193,7 @@
      }
  
      /* create the SASL connection */
-@@ -573,6 +611,11 @@
+@@ -783,6 +821,11 @@ int service_main(int argc __attribute__(
      prot_flush(imapd_out);
      snmp_increment(ACTIVE_CONNECTIONS, -1);
  
@@ -214,7 +205,7 @@
      /* cleanup */
      imapd_reset();
  
-@@ -646,6 +689,10 @@
+@@ -873,6 +916,10 @@ void shut_down(int code)
  
      cyrus_done();
  
@@ -225,8 +216,8 @@
      exit(code);
  }
  
-@@ -668,6 +715,35 @@
-     shut_down(code);
+@@ -932,6 +979,35 @@ static void imapd_check(struct backend *
+     }
  }
  
 +#ifdef DRAC_AUTH
@@ -261,7 +252,7 @@
  /*
   * Top-level command loop parsing
   */
-@@ -1680,6 +1756,11 @@
+@@ -2030,6 +2106,11 @@ void cmd_login(char *tag, char *user)
  
      prot_printf(imapd_out, "%s OK %s\r\n", tag, reply);
  
@@ -273,7 +264,7 @@
      /* Create telemetry log */
      imapd_logfd = telemetry_log(imapd_userid, imapd_in, imapd_out, 0);
  
-@@ -1803,6 +1884,11 @@
+@@ -2178,6 +2259,11 @@ cmd_authenticate(char *tag, char *authty
  
      prot_setsasl(imapd_in,  imapd_saslconn);
      prot_setsasl(imapd_out, imapd_saslconn);
@@ -286,13 +277,10 @@
      /* Create telemetry log */
      imapd_logfd = telemetry_log(imapd_userid, imapd_in, imapd_out, 0);
 Index: imap/pop3d.c
-===================================================================
-RCS file: /afs/andrew/system/cvs/src/cyrus/imap/pop3d.c,v
-retrieving revision 1.147
-diff -u -r1.147 pop3d.c
---- imap/pop3d.c	24 Oct 2003 18:24:07 -0000	1.147
-+++ imap/pop3d.c	19 Dec 2003 19:56:19 -0000
-@@ -101,6 +101,10 @@
+diff -u -p imap/pop3d.c.orig imap/pop3d.c
+--- imap/pop3d.c.orig	Sat Jun  4 08:07:46 2005
++++ imap/pop3d.c	Sat Dec 10 16:16:16 2005
+@@ -103,6 +103,10 @@ extern char *optarg;
  extern int opterr;
  
  
@@ -303,7 +291,7 @@
  
  #ifdef HAVE_SSL
  static SSL *tls_conn;
-@@ -394,6 +398,10 @@
+@@ -507,6 +511,10 @@ int service_main(int argc __attribute__(
      prot_settimeout(popd_in, timeout*60);
      prot_setflushonread(popd_in, popd_out);
  
@@ -314,7 +302,7 @@
      if (kflag) kpop();
  
      /* we were connected on pop3s port so we should do 
-@@ -1415,6 +1423,21 @@
+@@ -1636,6 +1644,21 @@ int openinbox(void)
  	popd_mailbox = &mboxstruct;
  	proc_register("pop3d", popd_clienthost, popd_userid,
  		      popd_mailbox->name);
@@ -337,13 +325,10 @@
  
      /* Create telemetry log */
 Index: imap/version.c
-===================================================================
-RCS file: /afs/andrew/system/cvs/src/cyrus/imap/version.c,v
-retrieving revision 1.15
-diff -u -r1.15 version.c
---- imap/version.c	15 Dec 2003 20:00:41 -0000	1.15
-+++ imap/version.c	19 Dec 2003 19:56:19 -0000
-@@ -145,6 +145,10 @@
+diff -u -p imap/version.c.orig imap/version.c
+--- imap/version.c.orig	Thu Feb 17 06:06:19 2005
++++ imap/version.c	Sat Dec 10 16:16:16 2005
+@@ -151,6 +151,10 @@ void id_response(struct protstream *pout
      snprintf(env_buf + strlen(env_buf), MAXIDVALUELEN - strlen(env_buf),
  	     "; %s", SIEVE_VERSION);
  #endif
@@ -355,13 +340,10 @@
      snprintf(env_buf + strlen(env_buf), MAXIDVALUELEN - strlen(env_buf),
  	     "; TCP Wrappers");
 Index: lib/imapoptions
-===================================================================
-RCS file: /afs/andrew/system/cvs/src/cyrus/lib/imapoptions,v
-retrieving revision 1.8
-diff -u -r1.8 imapoptions
---- lib/imapoptions	15 Dec 2003 20:00:42 -0000	1.8
-+++ lib/imapoptions	19 Dec 2003 19:56:19 -0000
-@@ -165,6 +165,14 @@
+diff -u lib/imapoptions.orig lib/imapoptions
+--- lib/imapoptions.orig	Fri Nov 18 00:46:29 2005
++++ lib/imapoptions	Sat Dec 10 16:19:44 2005
+@@ -195,6 +195,14 @@
  { "deleteright", "c", STRING }
  /* The right that a user needs to delete a mailbox. */
  
@@ -373,6 +355,6 @@
 +{ "drachost", "localhost", STRING }
 +/* Hostname of the RPC dracd server. */
 +
- { "duplicate_db", "berkeley-nosync", STRINGLIST("berkeley", "berkeley-nosync", "skiplist")}
+ { "duplicate_db", "berkeley-nosync", STRINGLIST("berkeley", "berkeley-nosync", "skiplist") }
  /* The cyrusdb backend to use for the duplicate delivery suppression
     and sieve. */
Index: imap/Makefile.in
===================================================================
RCS file: /afs/andrew/system/cvs/src/cyrus/imap/Makefile.in,v
retrieving revision 1.175.2.19
diff -u -r1.175.2.19 Makefile.in
--- imap/Makefile.in	13 Dec 2005 15:28:43 -0000	1.175.2.19
+++ imap/Makefile.in	13 Dec 2005 18:38:56 -0000
@@ -66,6 +66,7 @@
 SIEVE_LIBS = @SIEVE_LIBS@
 IMAP_COM_ERR_LIBS = @IMAP_COM_ERR_LIBS@
 LIB_WRAP = @LIB_WRAP@
+DRAC_LIBS = @DRACLIBS@
 LIBS = $(IMAP_LIBS) $(IMAP_COM_ERR_LIBS)
 DEPLIBS = ../lib/libcyrus.a ../lib/libcyrus_min.a @DEPLIBS@
 
@@ -202,17 +203,17 @@
 imapd: xversion $(IMAPDOBJS) mutex_fake.o libimap.a $(DEPLIBS) $(SERVICE)
 	$(CC) $(LDFLAGS) -o imapd \
 	 $(SERVICE) $(IMAPDOBJS) mutex_fake.o \
-	libimap.a $(DEPLIBS) $(LIBS) $(LIB_WRAP)
+	libimap.a $(DEPLIBS) $(LIBS) $(LIB_WRAP) $(DRAC_LIBS)
 
 imapd.pure: $(IMAPDOBJS) mutex_fake.o libimap.a $(DEPLIBS) $(SERVICE)
 	$(PURIFY) $(PUREOPT) $(CC) $(LDFLAGS) -o imapd.pure \
 	 $(SERVICE) $(IMAPDOBJS) mutex_fake.o libimap.a \
-	$(DEPLIBS) $(LIBS) $(LIB_WRAP)
+	$(DEPLIBS) $(LIBS) $(LIB_WRAP) $(DRAC_LIBS)
 
 imapd.quant: $(IMAPDOBJS) mutex_fake.o libimap.a $(DEPLIBS) $(SERVICE)
 	$(QUANTIFY) $(QUANTOPT) $(CC) $(LDFLAGS) -o imapd.quant \
 	 $(SERVICE) $(IMAPDOBJS) mutex_fake.o libimap.a \
-	$(DEPLIBS) $(LIBS) $(LIB_WRAP)
+	$(DEPLIBS) $(LIBS) $(LIB_WRAP) $(DRAC_LIBS) $(DRAC_LIBS)
 
 mupdate: mupdate.o mupdate-slave.o mupdate-client.o mutex_pthread.o tls.o \
 	libimap.a $(DEPLIBS)
@@ -230,7 +231,7 @@
 pop3d: pop3d.o proxy.o backend.o tls.o mutex_fake.o libimap.a \
 	$(DEPLIBS) $(SERVICE)
 	$(CC) $(LDFLAGS) -o pop3d pop3d.o proxy.o backend.o tls.o $(SERVICE) \
-	 mutex_fake.o libimap.a $(DEPLIBS) $(LIBS) $(LIB_WRAP)
+	 mutex_fake.o libimap.a $(DEPLIBS) $(LIBS) $(LIB_WRAP) $(DRAC_LIBS)
 
 nntpd: nntpd.o proxy.o backend.o index.o smtpclient.o spool.o tls.o \
 	 mutex_fake.o nntp_err.o libimap.a $(DEPLIBS) $(SERVICE)
Index: imap/imapd.c
===================================================================
RCS file: /afs/andrew/system/cvs/src/cyrus/imap/imapd.c,v
retrieving revision 1.443.2.68
diff -u -r1.443.2.68 imapd.c
--- imap/imapd.c	12 Dec 2005 21:23:59 -0000	1.443.2.68
+++ imap/imapd.c	13 Dec 2005 18:38:56 -0000
@@ -172,6 +172,18 @@
     1, 1, &imapd_authstate, &imapd_userisadmin, &imapd_userisproxyadmin
 };
 
+#ifdef DRAC_AUTH
+static struct {
+    int interval;		/* dracd "ping" interval; 0 = disabled */
+    unsigned long clientaddr;
+    struct prot_waitevent *event;
+} drac;
+
+extern int dracconn(char *server, char **errmsg);
+extern int dracsend(unsigned long userip, char **errmsg);
+extern int dracdisc(char **errmsg);
+#endif /* DRAC_AUTH */
+
 /* current sub-user state */
 static struct mailbox mboxstruct;
 static struct mailbox *imapd_mailbox;
@@ -636,6 +648,23 @@
     /* setup for sending IMAP IDLE notifications */
     idle_enabled();
 
+#ifdef DRAC_AUTH
+    /* setup for sending DRAC "pings" */
+    drac.event = NULL;
+    drac.interval = config_getint(IMAPOPT_DRACINTERVAL);
+    if (drac.interval < 0) drac.interval = 0;
+    if (drac.interval) {
+	char *err;
+
+	if (dracconn((char*) config_getstring(IMAPOPT_DRACHOST), &err) != 0) {
+	    /* disable DRAC */
+	    drac.interval = 0;
+	    syslog(LOG_ERR, "dracconn: %s", err);
+	    syslog(LOG_ERR, "DRAC notifications disabled");
+	}
+    }
+#endif /* DRAC_AUTH */
+
     /* create connection to the SNMP listener, if available. */
     snmp_connect(); /* ignore return code */
     snmp_set_str(SERVER_NAME_VERSION,CYRUS_VERSION);
@@ -740,6 +769,15 @@
 		imapd_haveaddr = 1;
 	    }
 	}
+
+#ifdef DRAC_AUTH
+	if (((struct sockaddr *)&imapd_remoteaddr)->sa_family == AF_INET)
+	    drac.clientaddr = ((struct sockaddr_in *)&imapd_remoteaddr)->sin_addr.s_addr;
+	else
+	    drac.clientaddr = 0;
+    } else {
+	drac.clientaddr = 0;
+#endif /* DRAC_AUTH */
     }
 
     /* create the SASL connection */
@@ -782,6 +820,11 @@
     prot_flush(imapd_out);
     snmp_increment(ACTIVE_CONNECTIONS, -1);
 
+#ifdef DRAC_AUTH
+    if (drac.event) prot_removewaitevent(imapd_in, drac.event);
+    drac.event = NULL;
+#endif /* DRAC_AUTH */
+
     /* cleanup */
     imapd_reset();
 
@@ -872,6 +915,10 @@
 
     cyrus_done();
 
+#ifdef DRAC_AUTH
+    if (drac.interval) (void) dracdisc((char **)NULL);
+#endif /* DRAC_AUTH */
+
     exit(code);
 }
 
@@ -931,6 +978,35 @@
     }
 }
 
+#ifdef DRAC_AUTH
+/*
+ * Ping dracd every 'drac.interval' minutes
+ * to let it know that we are still connected
+ */
+struct prot_waitevent *drac_ping(struct protstream *s,
+				 struct prot_waitevent *ev, void *rock)
+{
+    char *err;
+    static int nfailure = 0;
+
+    if (dracsend(drac.clientaddr, &err) != 0) {
+	syslog(LOG_ERR, "dracsend: %s", err);
+	if (++nfailure >= 3) {
+	    /* can't contact dracd for 3 consecutive tries - disable DRAC */
+	    prot_removewaitevent(s, ev);
+	    drac.event = NULL;
+	    syslog(LOG_ERR, "DRAC notifications disabled");
+	    return NULL;
+	}
+    }
+    else
+	nfailure = 0;
+
+    ev->mark = time(NULL) + (drac.interval * 60);
+    return ev;
+}
+#endif /* DRAC_AUTH */
+
 /*
  * Top-level command loop parsing
  */
@@ -2028,6 +2104,11 @@
 
     prot_printf(imapd_out, "%s OK %s\r\n", tag, reply);
 
+#ifdef DRAC_AUTH
+    if (drac.interval && drac.clientaddr)
+	drac.event = prot_addwaitevent(imapd_in, 0 /* now */, drac_ping, NULL);
+#endif /* DRAC_AUTH */
+
     /* Create telemetry log */
     imapd_logfd = telemetry_log(imapd_userid, imapd_in, imapd_out, 0);
 
@@ -2176,6 +2257,11 @@
 
     prot_setsasl(imapd_in,  imapd_saslconn);
     prot_setsasl(imapd_out, imapd_saslconn);
+
+#ifdef DRAC_AUTH
+    if (drac.interval && drac.clientaddr)
+	drac.event = prot_addwaitevent(imapd_in, 0 /* now */, drac_ping, NULL);
+#endif /* DRAC_AUTH */
 
     /* Create telemetry log */
     imapd_logfd = telemetry_log(imapd_userid, imapd_in, imapd_out, 0);
Index: imap/pop3d.c
===================================================================
RCS file: /afs/andrew/system/cvs/src/cyrus/imap/pop3d.c,v
retrieving revision 1.144.2.36
diff -u -r1.144.2.36 pop3d.c
--- imap/pop3d.c	12 Dec 2005 23:10:58 -0000	1.144.2.36
+++ imap/pop3d.c	13 Dec 2005 18:38:56 -0000
@@ -103,6 +103,10 @@
 extern int opterr;
 
 
+#ifdef DRAC_AUTH
+static int drac_enabled;
+extern int dracauth(char *server, unsigned long userip, char **errmsg);
+#endif /* DRAC_AUTH */
 
 #ifdef HAVE_SSL
 static SSL *tls_conn;
@@ -505,6 +509,10 @@
     prot_settimeout(popd_in, timeout*60);
     prot_setflushonread(popd_in, popd_out);
 
+#ifdef DRAC_AUTH
+    drac_enabled = (config_getint(IMAPOPT_DRACINTERVAL) > 0);
+#endif /* DRAC_AUTH */
+
     if (kflag) kpop();
 
     /* we were connected on pop3s port so we should do 
@@ -1634,6 +1642,21 @@
 	popd_mailbox = &mboxstruct;
 	proc_register("pop3d", popd_clienthost, popd_userid,
 		      popd_mailbox->name);
+
+#ifdef DRAC_AUTH
+	if (drac_enabled &&
+	    ((struct sockaddr *)&popd_remoteaddr)->sa_family == AF_INET) {
+	    char *err;
+
+	    if (dracauth((char*) config_getstring(IMAPOPT_DRACHOST),
+			 ((struct sockaddr_in *)&popd_remoteaddr)->sin_addr.s_addr, &err) != 0) {
+		/* disable DRAC */
+		drac_enabled = 0;
+		syslog(LOG_ERR, "dracauth: %s", err);
+		syslog(LOG_ERR, "DRAC notifications disabled");
+	    }
+	}
+#endif /* DRAC_AUTH */
     }
 
     /* Create telemetry log */
Index: imap/version.c
===================================================================
RCS file: /afs/andrew/system/cvs/src/cyrus/imap/version.c,v
retrieving revision 1.14.2.5
diff -u -r1.14.2.5 version.c
--- imap/version.c	16 Feb 2005 21:06:19 -0000	1.14.2.5
+++ imap/version.c	13 Dec 2005 18:38:56 -0000
@@ -151,6 +151,10 @@
     snprintf(env_buf + strlen(env_buf), MAXIDVALUELEN - strlen(env_buf),
 	     "; %s", SIEVE_VERSION);
 #endif
+#ifdef DRAC_AUTH
+    snprintf(env_buf + strlen(env_buf), MAXIDVALUELEN - strlen(env_buf),
+	     "; DRAC");
+#endif
 #ifdef HAVE_LIBWRAP
     snprintf(env_buf + strlen(env_buf), MAXIDVALUELEN - strlen(env_buf),
 	     "; TCP Wrappers");
Index: lib/imapoptions
===================================================================
RCS file: /afs/andrew/system/cvs/src/cyrus/lib/imapoptions,v
retrieving revision 1.2.2.38
diff -u -r1.2.2.38 imapoptions
--- lib/imapoptions	17 Nov 2005 15:46:29 -0000	1.2.2.38
+++ lib/imapoptions	13 Dec 2005 18:38:56 -0000
@@ -195,6 +195,14 @@
 { "deleteright", "c", STRING }
 /* The right that a user needs to delete a mailbox. */
 
+{ "dracinterval", 5, INT }
+/* If nonzero, enables the use of DRAC (Dynamic Relay Authorization
+   Control) by the pop3d and imapd daemons.  Also sets the interval
+   (in minutes) between re-authorization requests made by imapd. */
+
+{ "drachost", "localhost", STRING }
+/* Hostname of the RPC dracd server. */
+
 { "duplicate_db", "berkeley-nosync", STRINGLIST("berkeley", "berkeley-nosync", "skiplist") }
 /* The cyrusdb backend to use for the duplicate delivery suppression
    and sieve. */
