<!-- $Id: install-virtdomains.html,v 1.1.2.2 2002/08/22 14:55:15 ken3 Exp $ -->
<HTML>
<HEAD>
<TITLE>Configuring Virtual Domains
</title>
</head>
<h1>Configuring Virtual Domains
</h1>
<body>

<h2>Introduction</h2>
Virtual domains is the practice of hosting a service for more than one
domain on one server.  Cyrus IMAP has the ability to host IMAP/POP
mailboxes for multiple domains (e.g. test@example.com and
test@example.net) on a single server or Murder.

<p>In order to accomplish this, Cyrus needs to know which domain to look
in when a mailbox is accessed.  There are two ways in which Cyrus can
determine the domain:

<ul>
<li>Fully qualified userid - the client logs in with a userid
containing the domain in which the user belongs (e.g test@example.com
or test%example.net)</li>
<li>IP address - the server looks up the domain based on the IP
address of the receiving interface (useful for servers with multiple
NICs or using IP aliasing)</li>
</ul>

Both of these methods are always active and can be used in conjunction
with one another.  Note that a fully qualified userid takes precedence
over a domain obtained from the IP address.

<h2>Configuration</h2>
Support for virtual domains is enabled by turning on the
<tt>virtdomains</tt> option in <tt>imapd.conf</tt>.

<p>When upgrading from a single domain installation to a virtual
domain installation, the name of the existing domain should be
specified using the <tt>defaultdomain</tt> option in
<tt>imapd.conf</tt>.  This allows users to continue to access their
mailboxes using unqualified userids.

<h3>Multiple IP Addresses</h3>

In order to use a multiple IP address configuration, the server must
be able to do a reverse lookup on the IP address to determine the
hostname of the receiving interface.  For example:

<pre><kdb>
192.168.0.1  ->  mail.example.com
192.168.0.2  ->  mail.example.net
192.168.0.3  ->  mail.foo.bar
</kbd></pre>

<p>Once the server obtains the fully qualified hostname of the
interface, it removes the localpart (ie, 'mail') and uses the
remainder as the domain for any user that logs in.

<p>This address to hostname mapping would usually be done via DNS,
<tt>/etc/hosts</tt>, NIS, etc.  Configuration of the various naming
services is beyond the scope of this document.

<h3>Delivering mail</h3>

To deliver mail to your virtual domains, configure your MTA so that
the envelope recipient (RCPT TO) passed to <tt>lmtpd</tt> is fully
qualified with the correct domain.

<h2>Administration</h2>

To add a new domain, use the tool <tt>tools/mkimap</tt> to create the
appropriate directories:

<pre><kbd>
   su cyrus
   tools/mkimap -d example.com
   exit
</kbd></pre>

<h3>Administrators</h3>

The Cyrus virtual domains implementation supports per-domain
administrators as well as "global" (inter-domain) administrators.
Domain-specific administrators are specified with a fully qualified
userid in the <tt>admins</tt> option (e.g. admin@example.net) and only
have access to mailboxes in the associated domain.  Mailbox names
should be specified in the same fashion as on a single domain
configuration.

<p>Global administrators are specified with an unqualified userid in the
<tt>admins</tt> option and have access to <i>any</i> mailbox on the
server.  Global admins must use a <tt>mailbox@domain</tt> syntax when
specifying mailboxes.  Examples (using <tt>cyradm</tt>):

<p>To create a new user INBOX:

<pre><kbd>
   cm user.test@example.com
</kbd></pre>

To list all mailboxes in a domain:

<pre><kbd>
   lm *@example.com
</kbd><pre>

<P><HR>
last modified: $Date: 2002/08/22 14:55:15 $
</BODY></HTML>
