<!-- $Id: install-virtdomains.html,v 1.1.2.5 2002/11/14 16:04:16 ken3 Exp $ -->
<HTML>
<HEAD>
<TITLE>Configuring Virtual Domains
</title>
</head>
<h1>Configuring Virtual Domains
</h1>
<body>

<h2>Introduction</h2>
Virtual domains is the practice of hosting a service for more than one
domain on one server.  Cyrus IMAP has the ability to host IMAP/POP
mailboxes for multiple domains (e.g. <tt>test@example.com</tt> and
<tt>test@example.net</tt>) on a single server or Murder.

<p>In order to accomplish this, Cyrus needs to know which domain to look
in when a mailbox is accessed.  There are two ways in which Cyrus can
determine the domain:

<ul>
<li>Fully qualified userid - the client logs in with a userid
containing the domain in which the user belongs (e.g
<tt>test@example.com</tt> or <tt>test%example.net</tt>)</li>
<li>IP address - the server looks up the domain based on the IP
address of the receiving interface (useful for servers with multiple
NICs or using IP aliasing)</li>
</ul>

Both of these methods are always active and can be used in conjunction
with one another.  Note that a fully qualified userid takes precedence
over a domain obtained from the IP address.

<h2>Configuration</h2>
Support for virtual domains is enabled by turning on the
<tt>virtdomains</tt> option in <tt>imapd.conf</tt>.

<p>When upgrading from a single domain installation to a virtual
domain installation, the name of the existing domain (domain of the
server hostname) should be specified using the <tt>defaultdomain</tt>
option in <tt>imapd.conf</tt>.  This allows users to continue to
access their mailboxes using unqualified userids.  For example, if the
primary IP address on your server resolves to 'www.xxx.yyy.zzz',
then set <tt>defaultdomain</tt> to 'xxx.yyy.zzz'.

<p>Even for new installations, it is <i>recommended</i> that the
"real" domain of the server (domain of its primary hostname), be set
to the <tt>defaultdomain</tt>.  See <a href=#admins>Administrators</a>
below for further discussion.

<h3>Multiple IP Addresses</h3>

In order to use a multiple IP address configuration, the server must
be able to do a reverse lookup on the IP address to determine the
hostname of the receiving interface.  For example:

<pre><kbd>
192.168.0.1  ->  mail.example.com
192.168.0.2  ->  mail.example.net
192.168.0.3  ->  mail.foo.bar
</kbd></pre>

<p>Once the server obtains the fully qualified hostname of the
interface, it removes the localpart (ie, 'mail') and uses the
remainder as the domain for any user that logs in.

<p>This address to hostname mapping would usually be done via DNS,
<tt>/etc/hosts</tt>, NIS, etc.  Configuration of the various naming
services is beyond the scope of this document.

<h3>Delivering mail</h3>

To deliver mail to your virtual domains, configure your MTA so that
the envelope recipient (RCPT TO) passed to <tt>lmtpd</tt> is fully
qualified with the correct domain.

<h2>Administration</h2>

To add a new domain, use the tool <tt>tools/mkimap</tt> to create the
appropriate directories:

<pre><kbd>
   su cyrus
   tools/mkimap -d example.com
   exit
</kbd></pre>

<a name="admins"><h3>Administrators</h3></a>

The Cyrus virtual domains implementation supports per-domain
administrators as well as "global" (inter-domain) administrators.
Domain-specific administrators are specified with a
fully qualified userid in the <tt>admins</tt> option
(e.g. <tt>admin@example.net</tt>) and only have access to mailboxes in
the associated domain.  Mailbox names should be specified in the same
fashion as on a single domain configuration.

<p>Global administrators are specified with an unqualified userid in the
<tt>admins</tt> option and have access to <i>any</i> mailbox on the
server.  Because global admins use unqualified userids, they belong
to the <tt>defaultdomain</tt>.  As a result, you can NOT have a global
admin without specifying a <tt>defaultdomain</tt>.  Note that when
trying to login as a global admin to a multi-homed server from remote
machine, it might be necessary to fully qualify the userid with the
<tt>defaultdomain</tt>.

<p>Global admins must use a <tt>mailbox@domain</tt> syntax when
specifying mailboxes outside of the <tt>defaultdomain</tt>.  Examples
(using <tt>cyradm</tt>):

<p>To create a new INBOX for user 'test' in <tt>defaultdomain</tt>:

<pre><kbd>
   cm user.test
</kbd></pre>

<p>To create a new INBOX for user 'test' in domain 'example.com':

<pre><kbd>
   cm user.test@example.com
</kbd></pre>

To list all mailboxes in domain 'example.com':

<pre><kbd>
   lm *@example.com
</kbd></pre>

<P><HR>
last modified: $Date: 2002/11/14 16:04:16 $
</BODY></HTML>
